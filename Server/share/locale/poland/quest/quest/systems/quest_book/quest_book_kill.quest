quest quest_book_kill begin
    state start begin
        function get_full_progress()
            local data = quest_book.get_current_quest_data()
            local progress = 0
            for i in range(1, table.getn(data.mobs), 2) do
                local index = math.floor(i / 2)
                local currentProgress = pc.getqf("progress"..index)
                progress = progress + currentProgress
            end
            return progress
        end
    end
    state progress begin
        when login with not quest_book.is_on_quest() begin
            set_state(start)
        end

        when letter begin
            local data = quest_book.get_current_quest_data()
            send_letter_ex(data.title, "ex", "scroll_open_golden")
            q.set_counter(translate.general.left, quest_book_kill.get_full_progress())
        end

        when button or info begin
            local data = quest_book.get_current_quest_data()
            say_title(data.title)
            say()
            say_split(data.desc)
            say()
            for i in range(1, table.getn(data.mobs), 2) do
                local vnum = data.mobs[i]
                local count = data.mobs[i+1]
                local index = math.floor(i / 2)
                say_reward(msg(translate.quest_book.kill_progress, mob_name(vnum), pc.getqf("progress"..index), count))
            end

            if select(translate.general.continue, translate.general.cancel) == 2 then
               quest_book.abandon(false)
            end
        end

        when kill begin
            local data = quest_book.get_current_quest_data()
            for i in range(1, table.getn(data.mobs), 2) do
                local vnum = data.mobs[i]
                local index = math.floor(i / 2)
                local currentProgress = pc.getqf("progress"..index)
                if npc.get_race() == vnum then
                    if currentProgress > 0 then
                        pc.setqf("progress"..index, currentProgress - 1)
                    end

                    local total_progress = quest_book_kill.get_full_progress()
                    if total_progress < 1 then
                        q.set_counter(translate.general.left, 0)
                        set_state(start)
                        quest_book.reward()
                        clear_letter()
                    else
                        q.set_counter(translate.general.left, total_progress)
                    end
                    
                    break
                end
            end
        end
    end
end