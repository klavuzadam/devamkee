quest make_herb_lv4  begin
	state start begin
		when login or levelup with pc.get_level() >= 4  begin
			set_state(information)
		end	
	end

	state information begin
		when letter begin
			local v = find_npc_by_vnum(20084)
			if v != 0 then
				target.vid("__TARGET__", v, gameforge.collect_herb_lv10._10_targetVid)
			end
			send_letter(gameforge.collect_herb_lv4._10_sendLetter)
		end

		when button or info begin
			say_title(gameforge.collect_herb_lv4._10_sendLetter)
			say(gameforge.collect_herb_lv4._20_say)
		end
		
		when __TARGET__.target.click or	20084.chat.gameforge.collect_herb_lv10._40_npcChat begin
			target.delete("__TARGET__")
			say_title(gameforge.collect_herb_lv10._50_sayTitle)
			say(gameforge.collect_herb_lv4._30_say)
			wait()
			say_title(gameforge.collect_herb_lv10._50_sayTitle)
			say(gameforge.collect_herb_lv4._40_say)
			set_state(go_to_disciple)
			pc.setqf("collect_count",0)--Current number of items
		end
	end

	state go_to_disciple begin
		when letter begin
			send_letter(gameforge.collect_herb_lv10._80_sendLetter)
			
		end
		when button or info begin
			say_title(gameforge.collect_herb_lv4._50_sayTitle)
			say(gameforge.collect_herb_lv4._60_say)
			say_item_vnum(50701) 
			say_reward(string.format(gameforge.collect_herb_lv4._70_sayReward, pc.getqf("collect_count")))
		end

		when 173.kill begin
			if pc.count_item(50701)<6-pc.getqf("collect_count") then
				pc.give_item2(50701, 1)
			end
		end
		
    	when 20084.chat.gameforge.collect_herb_lv4._100_npcChat with pc.count_item(50701) > 0 begin
			say_title(gameforge.collect_herb_lv10._150_sayTitle)
			say(gameforge.collect_herb_lv10._160_say)
			pc.remove_item(50701, 1)
			wait()
			local pass_percent = 90
			local s= number(1,100)
			if s<= pass_percent  then
			   if pc.getqf("collect_count")< 4 then     --Less than 5 
					local index =pc.getqf("collect_count")+1 
					pc.setqf("collect_count",index)     --you got one, so you would get +1
					say_title(gameforge.collect_herb_lv10._50_sayTitle)
					say(string.format(gameforge.collect_herb_lv4._110_say, 5-pc.getqf("collect_count")))
					return
				end
				say_title(gameforge.collect_herb_lv10._50_sayTitle)
				say(gameforge.collect_herb_lv4._120_say)
				say_title(gameforge.collect_herb_lv4._130_sayTitle)
				say_reward(gameforge.collect_herb_lv4._140_sayReward)
				
				set_state(__complete)
				
				local weapon_reward_by_job = {
					[JOB_SHAMAN] = {7003},
					[JOB_ASSASSIN] = {1003, 2003},
					[JOB_WARRIOR] = {13, 3003},
					[JOB_SURA] = {13}
				}
				give_reward("herb_lv4")

				select_weapon_reward(weapon_reward_by_job[pc.job])

				pc.setqf("collect_count",0)
				clear_letter()
			else								
				say_title(gameforge.collect_herb_lv10._50_sayTitle)
				say(gameforge.collect_herb_lv4._170_say)
				return
			end
		end
	end
	state __complete begin
	end
end
