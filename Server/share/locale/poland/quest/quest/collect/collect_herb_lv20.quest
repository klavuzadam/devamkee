quest make_herb_lv20  begin
	state start begin
		when login or levelup with pc.get_level() >= 20  begin
			set_state(information)
		end	
	end

	state information begin
		when letter begin
			local v = find_npc_by_vnum(20084)
			if v != 0 then
				target.vid("__TARGET__", v, gameforge.collect_herb_lv10._10_targetVid)
			end
			send_letter(gameforge.collect_herb_lv20._20_sendLetter)
		end

		when button or info begin
			say_title(gameforge.collect_herb_lv20._20_sendLetter)
			say(gameforge.collect_herb_lv20._10_say)
		end
		
		when __TARGET__.target.click or	20084.chat.gameforge.collect_herb_lv10._40_npcChat begin
			target.delete("__TARGET__")
			say_title(gameforge.collect_herb_lv10._50_sayTitle)
			say(gameforge.collect_herb_lv10._60_say)
			wait()
			say_title(gameforge.collect_herb_lv10._50_sayTitle)
			say(gameforge.collect_herb_lv20._20_say)
			set_state(go_to_disciple)
			pc.setqf("collect_count",0)--Current number of items
		end
	end

	state go_to_disciple begin
		when letter begin
			send_letter(gameforge.collect_herb_lv15._50_sendLetter)
			
		end
		when button or info begin
			say_title(gameforge.collect_herb_lv20._30_sayTitle)
			say(gameforge.collect_herb_lv20._40_say)
			say_item_vnum(50705) 
			say_reward(string.format(gameforge.collect_herb_lv20._50_sayReward, pc.getqf("collect_count")))
		end

		when 182.kill begin
			if  pc.count_item(50705)< 12 - pc.getqf("collect_count")then
				pc.give_item2(50705, 1)
			end
		end
		
    	when 20084.chat.gameforge.collect_herb_lv20._70_npcChat with pc.count_item(50705) >0   begin
			say_title(gameforge.collect_herb_lv10._50_sayTitle)
			say(gameforge.collect_herb_lv20._80_say)
			pc.remove_item(50705, 1)
			wait()
			
			local pass_percent = 80
			local s= number(1,100)
			if s<= pass_percent  then
			   if pc.getqf("collect_count")< 9 then     --Less than 10 
					local index =pc.getqf("collect_count")+1 
					pc.setqf("collect_count",index)     --you got one, so you would get +1
					say_title(gameforge.collect_herb_lv20._90_sayTitle)
					say(string.format(gameforge.collect_herb_lv20._100_say, 10-pc.getqf("collect_count")))
					return
				end
				say_title(gameforge.collect_herb_lv10._50_sayTitle)
				say(gameforge.collect_herb_lv20._110_say)
				say_reward(gameforge.collect_herb_lv20._120_sayReward)
				
				pc.setqf("collect_count",0)
				
				clear_letter()
				set_state(__complete)
				
				give_reward("herb_lv20")
				return
			else								
				say_title(gameforge.collect_herb_lv10._50_sayTitle)
				say(gameforge.collect_herb_lv20._130_say)
				return
			end
		end
	end
	state __complete begin
	end
end
