quest desert_first_quest begin
    state start begin
        function task_data()
            return {
                {2001, 25},
                {2003, 20},
                {2102, 20},
                {2104, 15},
                {2106, 15},
            }
        end

        function can_start_quest()
            if pc.get_level() < 30 then
                return "low_lvl"
            elseif pc.get_reputation(FRACTION_DESERT) < 0 then
                return "low_reputation"
            elseif pc.getqf("reset_time") > get_time() then
                return "delay"
            end

            return "ok"
        end

        when login with pc.get_map_index() == 63 begin
            if desert_first_quest.can_start_quest() == "ok" then
                send_target(20406)
            end
        end

        when 20406.chat.translate.reputation_desert.first.name with pc.get_reputation(FRACTION_DESERT) >= 0 begin
            target.delete("__TARGET__")
            npc_name()

            local can_start = desert_first_quest.can_start_quest()
            if can_start == "low_lvl" then
                say_split(msg(translate.reputation.quest_low_lvl, 30))
                return
            elseif can_start == "low_reputation" then
                local rank = get_reputation_rank_by_total_value(0)
                say_split(msg(translate.reputation.quest_low_reputation, translate.reputation.reputation_rank[rank+1]))
                return
            elseif can_start == "delay" then
                say_split(translate.reputation.quest_wait)
                return
            end

            say_split(translate.reputation_desert.first.desc)
            say()

            local data = desert_first_quest.task_data()
            local quest_index = number(1, table.getn(data))
            local task_data = data[quest_index]
            say_reward(msg(translate.reputation_desert.first.task, task_data[2], mob_name(task_data[1])))

            pc.setqf("quest_index", quest_index)
            pc.setqf("reset_time", get_time() + time_until_hour(GLOBAL_COOLDOWN_RESET_HOUR))
            pc.setqf("progress", task_data[2])
            set_state(progress)
        end
    end
    state progress begin
        when login with desert_first_quest.can_start_quest() == "ok" begin
            set_state(start)
        end

        when letter begin
            send_letter_ex(translate.reputation_desert.first.name, "ex", "scroll_open_blue")
            q.set_counter(translate.general.left, pc.getqf("progress"))
        end

        when button or info begin
            say_info()
            say_split(translate.reputation_desert.first.desc)
            say()

            local task_data = desert_first_quest.task_data()[pc.getqf("quest_index")]
            say_reward(msg(translate.reputation_desert.first.task, task_data[2], mob_name(task_data[1])))
            say_reward(translate.general.left..": "..pc.getqf("progress"))
        end

        when kill with not npc.is_pc() begin
            local task_data = desert_first_quest.task_data()[pc.getqf("quest_index")]
            if npc.get_race() == task_data[1] then
                pc.setqf("progress", pc.getqf("progress") - 1)
                q.set_counter(translate.general.left, pc.getqf("progress"))
                if pc.getqf("progress") < 1 then
                    set_state(reward)
                end
            end
        end
    end
    state reward begin
        when login with desert_first_quest.can_start_quest() == "ok" begin
            set_state(start)
        end

        when letter begin
            send_letter_ex(translate.reputation_desert.first.name, "ex", "scroll_open_blue")
            send_target(20406)
        end

        when button or info begin
            say_info()
            say_split(translate.reputation.quest_done_letter)
        end

        when 20406.chat.translate.reputation_desert.first.name begin
            target.delete("__TARGET__")
            npc_name()
            say_split(translate.reputation_desert.quest_done)
            say()
            set_state(start)

            give_reward("desert_rep1")
            
            say_reward(msg(translate.reputation.quest_reward_reputation, 750, translate.reputation_desert.fraction_name))
            pc.add_reputation(FRACTION_DESERT, 750)

            clear_letter()
        end
    end
end