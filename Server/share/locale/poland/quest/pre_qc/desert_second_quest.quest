quest desert_second_quest begin
    state start begin
        function task_data()
            return {
                {50721, 15},
                {50722, 15},
                {50723, 10},
                {50724, 10},
                {50725, 10},
                {50603, 30},
                {50604, 30},
                {50606, 30},
                {50607, 30},
                {27803, 2},
                {27804, 2},
            }
        end

        function can_start_quest()
            if pc.get_level() < 40 then
                return "low_lvl"
            elseif pc.get_reputation(FRACTION_DESERT) < 3000 then
                return "low_reputation"
            elseif pc.getqf("reset_time") > get_time() then
                return "delay"
            end

            return "ok"
        end

        when login with pc.get_map_index() == 63 begin
            if desert_second_quest.can_start_quest() == "ok" then
                send_target(20407)
            end
        end

        when 20407.chat.translate.reputation_desert.second.name with pc.get_reputation(FRACTION_DESERT) >= 3000 begin
            target.delete("__TARGET__")
            npc_name()

            local can_start = desert_second_quest.can_start_quest()
            if can_start == "low_lvl" then
                say_split(msg(translate.reputation.quest_low_lvl, 40))
                return
            elseif can_start == "low_reputation" then
                local rank = get_reputation_rank_by_total_value(3000)
                say_split(msg(translate.reputation.quest_low_reputation, translate.reputation.reputation_rank[rank+1]))
                return
            elseif can_start == "delay" then
                say_split(translate.reputation.quest_wait)
                return
            end

            say_split(translate.reputation_desert.second.desc)
            say()

            local data = desert_second_quest.task_data()
            local quest_index = number(1, table.getn(data))
            local task_data = data[quest_index]
            say_item_vnum(task_data[1])
            say_reward(msg(translate.reputation_desert.second.task, task_data[2], item_name(task_data[1])))

            pc.setqf("quest_index", quest_index)
            pc.setqf("reset_time", get_time() + time_until_hour(GLOBAL_COOLDOWN_RESET_HOUR))
            set_state(progress)
        end
    end
    state progress begin
        when login with desert_second_quest.can_start_quest() == "ok" begin
            set_state(start)
        end

        when letter begin
            send_letter_ex(translate.reputation_desert.second.name, "ex", "scroll_open_blue")
        end

        when button or info begin
            say_info()
            say_split(translate.reputation_desert.second.desc)
            say()

            local task_data = desert_second_quest.task_data()[pc.getqf("quest_index")]
            say_item_vnum(task_data[1])
            say_reward(msg(translate.reputation_desert.second.task, task_data[2], item_name(task_data[1])))
        end

        when 20407.chat.translate.reputation_desert.second.name begin
            npc_name()
            local task_data = desert_second_quest.task_data()[pc.getqf("quest_index")]
            if pc.count_item(task_data[1]) < task_data[2] then
                say_split(translate.reputation_desert.second.no_items)
                say_item_vnum(task_data[1])
                say_reward(msg(translate.reputation_desert.second.task, task_data[2], item_name(task_data[1])))
                return
            end
            
            pc.remove_item(task_data[1], task_data[2])

            say_split(translate.reputation_desert.quest_done)
            say()
            set_state(start)

            give_reward("desert_rep2")
            
            say_reward(msg(translate.reputation.quest_reward_reputation, 750, translate.reputation_desert.fraction_name))
            pc.add_reputation(FRACTION_DESERT, 750)

            clear_letter()
        end
    end
end