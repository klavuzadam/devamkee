quest deviltower_zone begin
    state start begin
        function get_data() 
            return {
                base_x = 1280,
                base_y = 7936,
                level_coords = {
                    {x=126, y=384, regen="data/dungeon/deviltower2_regen.txt"},
                    {x=134, y=147, regen="data/dungeon/deviltower3_regen.txt"},
                    {x=369, y=629, regen="data/dungeon/deviltower4_regen.txt"},
                    {x=369, y=401, regen="data/dungeon/deviltower5_regen.txt"},
                    {x=374, y=167, regen="data/dungeon/deviltower6_regen.txt"},
                    {x=621, y=631, regen="data/dungeon/deviltower7_regen.txt"},
                    {x=616, y=399, regen="data/dungeon/deviltower8_regen.txt"},
                    {x=591, y=159, regen="data/dungeon/deviltower9_regen.txt"},
                },
            }
        end

        function get_level_location(level)
            local data = deviltower_zone.get_data()
            local level_data = data.level_coords[level]
            return {x = data.base_x + level_data.x, y = data.base_y + level_data.y, regen=level_data.regen}
        end

        when login begin
            if pc.get_map_index() == 66 then
                if pc.getqf("pass_enter") == 0 then
                    pc.warp((5376+532)*100, (512+596+4)*100, 65)
                    return
                end
                pc.delqf("pass_enter")
                -- if pc.get_x() < 1280+88 or pc.get_y() < 7936+577 or pc.get_x() > 1280+236 or pc.get_y() > 7936+737 then
                --     pc.warp((5376+532)*100, (512+596+4)*100, 65)
                -- end
            end
            --     pc.set_warp_location(65, 5376+532, 512+596+4)
            -- elseif pc.get_map_index() >= 660000 and pc.get_map_index() < 670000 then
            --     pc.set_warp_location(65, 5376+532, 512+596+4)
            -- end

            if in_dungeon(66) then
                pc.set_exit_location(66, 1397, 8550)
                pc.set_warp_location(66, 1397, 8550)
                if d.get_level() == 5 then
                    d.affect_all(AFFECT_DEVILTOWER_DAMAGE, POINT_CURSE_PCT,  d.getf("damage") * 5, INFINITE_AFFECT_DURATION)
                end
            elseif pc.has_affect(AFFECT_DEVILTOWER_DAMAGE) then
                affect.remove_new(AFFECT_DEVILTOWER_DAMAGE)
                debug("usuwam?")
            end
        end

        when logout begin
            if pc.count_item(30300) >= 1 then
                pc.remove_item(30300, pc.count_item(30300))
            end
            if pc.count_item(30302) >= 1 then
                pc.remove_item(30302, pc.count_item(30302))
            end
            if pc.count_item(30304) >= 1 then
                pc.remove_item(30304, pc.count_item(30304))
            end

            if in_dungeon(66) then
                if pc.has_affect(AFFECT_DEVILTOWER_DAMAGE) then
                    affect.remove_new(AFFECT_DEVILTOWER_DAMAGE)
                end

                if d.get_level() == 4 and pc.getqf("can_refine") == 0 then
                    pc.setqf("enter_count", pc.getqf("enter_count")+1)
                end
            end
        end

        when deviltower_man.chat.translate.general.open_shop begin
            npc_name()
            say_split(translate.deviltower_zone.chat_shop)
            say()
            wait()
            setskin(NOWINDOW)
            pc.open_special_shop(101)
        end
        
        when deviltower_man.chat.gameforge.deviltower_zone._10_npcChat begin
            local beta_state = game.get_event_flag("beta_server") 
            if beta_state > 0 and beta_state < 2 then
                say_title(gameforge.deviltower_zone._20_sayTitle)
                say_reward("BETA: DT jest dostepne od 2 etapu.")
                return
            end

            if pc.get_level() < 40 then
                say_title(gameforge.deviltower_zone._20_sayTitle)
                say(gameforge.deviltower_zone._30_say)
                return
            end

            local time_until_reset = pc.getqf("enter_reset")
            if get_time() > time_until_reset then
                pc.setqf("enter_count", 0)
                pc.setqf("enter_reset", get_time() + time_until_hour(GLOBAL_COOLDOWN_RESET_HOUR))
            end

            local limits = {
                {40, 1, 2},
                {45, 1, 3},
                {50, 2, 4},
                {55, 3, 6},
                {60, 4, 9},
                {65, 6, 14},
                {70, 8, 18},
                {75, 10, 24},
            }

            local has_premium_key = pc.count_item(30377) > 0
            local is_premium_enter = false
            local max_normal_enter_limit = 0
            local max_premium_enter_limit = 0

            for i=1, table.getn(limits) do
                local index = table.getn(limits) - (i-1)
                local limit = limits[index]
                if pc.get_level() >= limit[1] then
                    max_normal_enter_limit = limit[2]
                    max_premium_enter_limit = limit[3]
                    break
                end
            end

            local enter_count = pc.getqf("enter_count")
            local max_player_enter_limit = max_normal_enter_limit

            if enter_count >= max_normal_enter_limit then
                if has_premium_key and enter_count < max_premium_enter_limit then
                    max_player_enter_limit = max_premium_enter_limit
                    is_premium_enter = true
                else
                    debug("has_premium_key %s, enter_count %d, max_count %d", tostring(has_premium_key), enter_count, max_player_enter_limit)
                    say_title(gameforge.deviltower_zone._20_sayTitle)
                    say_split(msg(translate.deviltower_zone.limit_full))
                    return
                end
            end

            local left_count = math.max(max_player_enter_limit - enter_count, 0)

            say_title(gameforge.deviltower_zone._20_sayTitle)
            say(gameforge.deviltower_zone._40_say)
            say()
            if is_premium_enter then
                say_reward(msg(translate.deviltower_zone.current_limit_premium, left_count))
                say_split(translate.deviltower_zone.enter_premium_info, say_reward)
            else
                say_reward(msg(translate.deviltower_zone.current_limit, left_count))
            end

            local s =  select(gameforge.locale.monkey_dungeon.enter, translate.deviltower_zone.limit_option, gameforge.locale.monkey_dungeon.no_enter)
            if s == 1 then
                if not pc.can_warp() then
                    npc_name()
                    say(translate.general.wait_after_exchange)
                    return
                end

                if pc.is_busy() then
                    npc_name()
                    say(translate.general.wait_after_exchange)
                    return
                end

                if is_premium_enter then
                    if pc.count_item(30377) < 1 then
                        return
                    end
                    pc.remove_item(30377, 1)
                end
                
                pc.setqf("pass_enter", 1)
                pc.warp((1280 + 117)*100, (7936 + 614)*100)
            elseif s == 2 then
                say_title(gameforge.deviltower_zone._20_sayTitle)
                say_split(translate.deviltower_zone.limit_info1)
                say()
                say_split(translate.deviltower_zone.limit_info2, say_reward)
                say()
                wait()
                say_title(gameforge.deviltower_zone._20_sayTitle)
                say_split(translate.deviltower_zone.limit_premium_info1)
                say_item_vnum(30377)
                say_split(translate.deviltower_zone.limit_premium_info2)
                say()
                say_split(translate.deviltower_zone.limit_premium_info3, say_reward)
                say()
            end
        end

        -- PARTER
        when 8015.kill with pc.get_map_index() == 66 begin
            timer("deviltower_create_dungeon", 6)
        end

        when deviltower_create_dungeon.timer begin
            -- create dungeon and warp to dungeon
            local first_location = deviltower_zone.get_level_location(1)
            debug("%d %d", first_location.x, first_location.y)
            d.new_jump_all(66, first_location.x, first_location.y)
            d.regen_file(first_location.regen)

            -- set first level task
            local second_location = deviltower_zone.get_level_location(2)
            d.set_warp_at_eliminate(4, d.get_map_index(), second_location.x, second_location.y, second_location.regen)
        end

        when 1091.kill with in_dungeon(66) and d.get_level() == 1 begin
            local third_location = deviltower_zone.get_level_location(3)
            d.set_warp_at_eliminate(8, d.get_map_index(), third_location.x, third_location.y, third_location.regen)
            d.check_eliminated()
        end

        function get_4floor_stone_pos()
            local positions = 
                {
                    {368, 629}, {419, 630}, {428, 653}, {422, 679},
                    {395, 689}, {369, 679}, {361, 658},
            }
            for i = 1, 6 do
                local j = number(i, 7)
                if i != j then
                    local t = positions[i];
                    positions[i] = positions[j];
                    positions[j] = t;
                end
            end
            return positions
        end

        when 8016.kill with pc.in_dungeon() and in_dungeon(66) and d.get_level() == 2 begin
            local positions = deviltower_zone.get_4floor_stone_pos()

            for i = 1, 6 do
                debug(positions[i][1], positions[i][2])
                d.set_unique("fake" .. i , d.spawn_mob(8017, positions[i][1], positions[i][2]))
            end

            debug(positions[7][1], positions[7][2])

            local vid = d.spawn_mob(8017, positions[7][1], positions[7][2])
            debug(vid)
            d.set_unique("real", vid)
            server_loop_timer('devil_stone4_update', 10, pc.get_map_index())
            server_timer('devil_stone4_fail1', 5*60, pc.get_map_index())
            
            notice_multiline(gameforge.deviltower_zone._50_dNotice,d.notice)
            
        end

        when devil_stone4_fail1.server_timer begin
            if d.select(get_server_timer_arg()) then
                notice_multiline(gameforge.deviltower_zone._60_dNotice,d.notice)
                server_timer('devil_stone4_fail2', 5*60, get_server_timer_arg())
            end
        end

        when devil_stone4_fail2.server_timer begin
            if d.select(get_server_timer_arg()) then
                notice_multiline(gameforge.deviltower_zone._70_dNotice,d.notice)
                server_timer('devil_stone4_fail', 5*60, get_server_timer_arg())
            end
        end

        when devil_stone4_fail.server_timer begin
            if d.select(get_server_timer_arg()) then
                notice_multiline(gameforge.deviltower_zone._80_dNotice,d.notice)
                d.clear_regen()
                d.exit_all()
                d.mark_destroyed()
                clear_server_timer('devil_stone4_update', get_server_timer_arg())
            end
        end

        when devil_stone4_update.server_timer begin
            if d.select(get_server_timer_arg()) then
                if not d.is_unique_dead("real") then
                    for i = 1, 6 do
                        if d.getf("fakedead" .. i) == 0 then
                            if d.unique_get_hp_perc("fake" .. i) < 50 then
                                d.purge_unique("fake" .. i)
                                d.setf("fakedead" .. i, 1)
                                notice_multiline(gameforge.deviltower_zone._90_dNotice,d.notice)
                            end
                        end
                    end
                else
                    server_timer("devil_stone4_end", 5, get_server_timer_arg())
                    d.purge()
                    notice_multiline(gameforge.deviltower_zone._100_dNotice,d.notice)
                    clear_server_timer('devil_stone4_fail1', get_server_timer_arg())
                    clear_server_timer('devil_stone4_fail2', get_server_timer_arg())
                    clear_server_timer('devil_stone4_fail', get_server_timer_arg())
                end
            else
                server_timer('devil_stone4_stop_timer', 1, get_server_timer_arg())
            end
        end

        when devil_stone4_stop_timer.server_timer begin
            clear_server_timer('devil_stone4_update', get_server_timer_arg())
        end

        when devil_stone4_end.server_timer begin
            if d.select(get_server_timer_arg()) then
                clear_server_timer('devil_stone4_update', get_server_timer_arg())
                clear_server_timer('devil_stone4_fail1', get_server_timer_arg())
                clear_server_timer('devil_stone4_fail2', get_server_timer_arg())
                clear_server_timer('devil_stone4_fail', get_server_timer_arg())
                
                -- clear regen from memory when exit
                d.clear_regen()
                
                d.advance_level()
                d.setf("stone_count", 5)
                notice_multiline(gameforge.deviltower_zone._110_dNotice,d.notice)

                local fourth_location = deviltower_zone.get_level_location(4)

                d.jump_all(fourth_location.x, fourth_location.y)
                server_timer('devil_stone5_fail1', 5*60, get_server_timer_arg())
                clear_server_timer('devil_stone4_update', get_server_timer_arg())

                d.set_regen_file(fourth_location.regen)

                d.spawn_mob(20073, 421, 452)
                d.spawn_mob(20073, 380, 460)
                d.spawn_mob(20073, 428, 414)
                d.spawn_mob(20073, 398, 392)
                d.spawn_mob(20073, 359, 426)
            end
        end
        when devil_stone5_fail1.server_timer begin
            if d.select(get_server_timer_arg()) then
                notice_multiline(gameforge.deviltower_zone._120_dNotice,d.notice)
                server_timer('devil_stone5_fail2', 5*60, get_server_timer_arg())
            end
        end

        when devil_stone5_fail2.server_timer begin
            if d.select(get_server_timer_arg()) then
                notice_multiline(gameforge.deviltower_zone._60_dNotice,d.notice)
                server_timer('devil_stone5_fail3', 5*60, get_server_timer_arg())
            end
        end

        when devil_stone5_fail3.server_timer begin
            if d.select(get_server_timer_arg()) then
                notice_multiline(gameforge.deviltower_zone._70_dNotice,d.notice)
                server_timer('devil_stone5_fail', 5*60, get_server_timer_arg())
            end
        end

        when devil_stone5_fail.server_timer begin
            if d.select(get_server_timer_arg()) then
                notice_multiline(gameforge.deviltower_zone._80_dNotice,d.notice)
                d.exit_all()
                d.mark_destroyed()
            end
        end


        when 1062.kill with pc.in_dungeon() and d.get_level() == 3 begin
            local n =d.getf("count") + 1
            d.setf("count", n) 
            if n == 50 then
                game.drop_item(50084, 1)
                d.setf("count", 0)
            end
        end

        when 20073.take with item.vnum == 50084 and in_dungeon(66) and d.get_level() == 3 begin
            if not check_safe_item() then return end
            npc.purge()

            if item.remove() then
                d.setf("stone_count", d.getf("stone_count") - 1)
                if d.getf("stone_count") <= 0 then
                    d.advance_level()
                    d.clear_regen()

                    local fifth_location = deviltower_zone.get_level_location(5)
                    d.regen_file(fifth_location.regen)
        
                    notice_multiline(gameforge.deviltower_zone._130_dNotice,d.notice)
                    d.jump_all(fifth_location.x, fifth_location.y)
                    local server_arg = d.get_map_index()
                    clear_server_timer('devil_stone5_fail1', server_arg)
                    clear_server_timer('devil_stone5_fail2', server_arg)
                    clear_server_timer('devil_stone5_fail3', server_arg)
                    clear_server_timer('devil_stone5_fail', server_arg)
                else
                    d.notice(string.format(gameforge.deviltower_zone._140_dNotice, d.getf("stone_count")))
                end
            end
        end

        when write with mes.get_message() == "deviltower_jump_smith" and pc.is_gm() and in_dungeon(66) begin
            if d.get_level() > 1 then
                syschat("GM: Musisz byc na 1 lub 2 pietrze DT.")
                return
            end
            d.reset_warp_at_eliminate()
            d.set_level(4)
            d.clear_regen()
            local fifth_location = deviltower_zone.get_level_location(5)
            d.regen_file(fifth_location.regen)
            d.jump_all(fifth_location.x, fifth_location.y)
        end

        when 1092.kill with in_dungeon(66) and d.get_level() == 4 begin
            d.kill_all()
            notice_multiline(gameforge.deviltower_zone._150_dNotice,d.notice)
            d.check_eliminated()
            notice_multiline(gameforge.deviltower_zone._160_dNotice,d.notice)
            local reward_alchemist = {20074, 20075, 20076}
            d.spawn_mob(table_get_random_item(reward_alchemist), 425, 216)
            d.setqf2("deviltower_zone","can_refine", 1)
            d.setqf2("deviltower_zone","6_done", 1)
        end

        when 20074.chat.gameforge.deviltower_zone._170_npcChat or 20075.chat.gameforge.deviltower_zone._170_npcChat or 20076.chat.gameforge.deviltower_zone._170_npcChat with in_dungeon(66) and d.get_level() == 4 begin
            if npc.is_custom_flag2(CUSTOM_NPC_FLAG_LOCK_INTERACTION) then
                setskin(NOWINDOW)
                return
            end
            
            npc.set_custom_npc_flag2(CUSTOM_NPC_FLAG_LOCK_INTERACTION)
            npc_name()
            say(gameforge.deviltower_zone._190_say)
            wait()
            if pc.get_level() >= 75 or pc.is_gm() then
                npc_name()
                say(gameforge.deviltower_zone._200_say)
                local s= select(gameforge.deviltower_zone._210_select, gameforge.locale.cancel, gameforge.deviltower_zone._220_select)
                if s==3 then
                    pc.warp(590500, 110900)
                    npc.set_custom_npc_flag2(CUSTOM_NPC_FLAG_LOCK_INTERACTION, false)
                    return
                end	
                if s==2 then
                    npc.set_custom_npc_flag2(CUSTOM_NPC_FLAG_LOCK_INTERACTION, false)
                    return
                end

                timer("devil_jump_7", 6)
                d.purge()
                return
            end
            npc_name()
            say(gameforge.deviltower_zone._230_say)
            wait()
            pc.warp(590500, 110500)
            npc.set_custom_npc_flag2(CUSTOM_NPC_FLAG_LOCK_INTERACTION, false)
            return
        end

        when devil_jump_7.timer begin
            d.clear_regen()

            d.spawn_mob(8018, 639, 658)
            d.spawn_mob(8018, 611, 637)
            d.spawn_mob(8018, 596, 674)
            d.spawn_mob(8018, 629, 670)


            d.advance_level()

            d.setqf2("deviltower_zone","enter_count", 1, true)

            notice_multiline(gameforge.deviltower_zone._240_dNotice,d.notice)

            local sixth_location = deviltower_zone.get_level_location(6)
            d.jump_all(sixth_location.x, sixth_location.y)
        end

        when 8018.kill with in_dungeon(66) and d.get_level() == 5 begin
            local cont = d.getf("7_stone_kill") + 1
            d.setf("7_stone_kill", cont)

            if cont >= 4 then
                d.setf("7_stone_kill", 0)
                local sixth_location = deviltower_zone.get_level_location(6)
                d.set_regen_file(sixth_location.regen)
                
                local start_loop_time = 15*60
                if is_test_server() then
                    start_loop_time = 10
                end
                server_timer('devil_7_start_loop', start_loop_time, pc.get_map_index())
            end	
        end

        when devil_7_start_loop.server_timer begin
            if d.select(get_server_timer_arg()) then
                notice_multiline(gameforge.deviltower_zone._120_dNotice,d.notice)

                local delay = 5*60
                if is_test_server() then
                    delay = 10
                end
                server_loop_timer('devil_7_loop', delay, get_server_timer_arg())
            end
        end

        when devil_7_loop.server_timer begin -- increase damage with time
            if d.select(get_server_timer_arg()) then
                d.setf("damage", d.getf("damage")+1)
                d.affect_all(AFFECT_DEVILTOWER_DAMAGE, POINT_CURSE_PCT, d.getf("damage") * 3, INFINITE_AFFECT_DURATION)
            end
        end

        when 8019.kill with in_dungeon(66) and d.get_level() == 5 begin
            game.drop_item(30300, 1)
        end

        when 30300.use with in_dungeon(66) and d.get_level() == 5 begin
            pc.remove_item(30300, 1)

            local pct = number(1,10)

            if pct == 1 then
                game.drop_item(30302, 1)
                d.clear_regen()
            else
                syschat(translate.deviltower_zone.chest_no_key)
            end
        end

        when 30302.use with in_dungeon(66) begin
            if d.get_level() != 5 then
                pc.remove_item(30302, 1)
                return
            end
            
            say_title(gameforge.blacksmith._40_sayTitle)
            say(gameforge.deviltower_zone._250_say)
            pc.remove_item(30302, 1)
            timer("devil_jump_8", 6)
            d.clear_regen()
        end

        when devil_jump_8.timer begin
            d.advance_level()

            d.setf("damage", 0)
            clear_server_timer('devil_7_loop', d.get_map_index())
            d.remove_affect_all(AFFECT_DEVILTOWER_DAMAGE)

            notice_multiline(gameforge.deviltower_zone._260_dNotice,d.notice)

            local seventh_location = deviltower_zone.get_level_location(7)

            d.jump_all(seventh_location.x, seventh_location.y)
            d.set_regen_file(seventh_location.regen)
            d.spawn_mob(20366, 640, 460)
            local _count = pc.count_item(30302)
            pc.remove_item(30302,_count)
            
        end

        when 1040.kill with in_dungeon(66) and d.get_level() == 6 begin
            local pct1 = number(1, 5)
            if pct1 == 1 then
                local pct2 = number(1, 10)
                if pct2 == 1 then
                    game.drop_item(30304, 1)
                else
                    game.drop_item(30303, 1)
                end
            else
                return
            end
        end

        when 20366.take with item.vnum == 30304 and in_dungeon(66) and d.get_level() == 6 begin
            if not check_safe_item() then return end

            if item.remove() then
                npc.purge()
                timer("devil_jump_9", 6)
            end
        end

        when devil_jump_9.timer begin
            d.advance_level()
            notice_multiline(gameforge.deviltower_zone._270_dNotice,d.notice)

            local eighth_location = deviltower_zone.get_level_location(8)
            d.jump_all(eighth_location.x, eighth_location.y)
            d.regen_file(eighth_location.regen)
        end

        when 1093.kill with in_dungeon(66) and d.get_level() == 7 begin
            d.kill_all()
            d.setqf2("deviltower_zone","9_done", 1)
            d.add_player_stat(PLAYER_STATS_DUNGEON_FLAG)
            notice_multiline(gameforge.deviltower_zone._280_dNotice,d.notice)
            notice_multiline(gameforge.deviltower_zone._290_dNotice,d.notice)
            server_timer("devil_end_jump", 60, d.get_map_index())
        end

        when devil_end_jump.server_timer begin
            if d.select (get_server_timer_arg()) then
                d.clear_regen()
                d.exit_all()
                d.mark_destroyed()
            end
        end
    end
end