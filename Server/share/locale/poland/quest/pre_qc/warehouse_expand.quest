quest warehouse_expand begin
    state start begin

        -- quest already done on a different character on the account
        when login with game.get_safebox_level() > 1 begin
            set_state(__COMPLETE__)
        end

        function abort_quest()
            say_info()
            say_split(translate.warehouse_expand.state_progress.fail, say_reward)
            cleartimer("warehouse_expand_time")
            cleartimer("warehouse_expand_ambush")
            q.set_clock("Czas", 0)
            if pc.has_affect(AFFECT_QUEST_USE) then
                affect.remove(AFFECT_QUEST_USE)
            end
            set_state("start")
        end

        function ambush()
            local spawnMobs = {554, 554, 552, 552, 553}
            for i, vnum in ipairs(spawnMobs) do
                local random_pos = number(1,100) / 100
                local x, y = getPositionOnCircle(pc.get_x(), pc.get_y(), 7, random_pos)
                local vid = spawn_mob(vnum, x*100, y*100, 0, pc.get_vid())
                if vid > 0 then
                    npc.set_custom_npc_flag(vid, CUSTOM_NPC_FLAG_PURGE_ON_AGGRO_LOSE)
                    npc.say(vid, table_get_random_item(translate.warehouse_expand.state_progress.ambush_mob_say))
                end
            end

            local rnd = number(1,2)
            if rnd == 1 then
                affect.add_new(AFFECT_STUN, POINT_NONE, 0, number(4,7), AFF_STUN, true)
            elseif rnd == 2 then
                pc.knockback(250)
                affect.add_new(AFFECT_SLOW, POINT_MOV_SPEED, -40, 15, AFF_SLOW, true)
            end
        end

        when 9005.chat.translate.warehouse_expand.state_start.npc_chat with game.get_safebox_level() > 0 and pc.get_account_flag("safebox_level") == 0 and pc.get_map_index() == get_player_map1_index() begin
            npc_name()
            if pc.get_level() < 30 then
                say_split(translate.warehouse_expand.state_start.npc_low_level)
                return
            end
            say_split(string.format(translate.warehouse_expand.state_start.npc_talk1, get_map_name(get_player_map2_index())))
            wait()
            npc_name()
            say_split(translate.warehouse_expand.state_start.npc_talk2)
            say()
            say_reward(translate.warehouse_expand.state_start.add_info)
            if select(translate.general.yes, translate.general.no) == 2 then
                setskin(NOWINDOW)
                return
            end
            npc_name()

            if horse.is_riding() then
                say_split(translate.warehouse_expand.state_start.riding_horse)
                return
            end

            say_split(translate.warehouse_expand.state_start.npc_talk3)
            affect.add_new(AFFECT_QUEST_USE, POINT_MOV_SPEED, -30, 600, AFF_QUEST_BOX, true)
            pc.setqf("start_quest", get_time()+600)
            set_state(progress)
        end
    end
    state progress begin
        when letter begin
            local duration = pc.getqf("start_quest") - get_time()
            debug("left: %d", duration)
            if duration < 1 then
                warehouse_expand.abort_quest()
                return
            end
            
            send_letter(translate.warehouse_expand.quest_name)
            if pc.get_map_index() == get_player_map2_index() then
                send_target(9005)
            end

            q.set_clock("Czas", duration)
            timer("warehouse_expand_time", duration)
            loop_timer("warehouse_expand_ambush", 30)
        end

        when warehouse_expand_ambush.timer begin
            if not is_player_in_m1_city() and not is_player_in_m2_city() then
                local rnd = number(1,4) 
                debug("wylosowalo "..rnd)
                if rnd <= pc.getqf("ambush_chance")+1 then
                    warehouse_expand.ambush()
                    pc.setqf("ambush_chance", 0)
                else
                    pc.setqf("ambush_chance", pc.getqf("ambush_chance") + 1)
                end
            end
        end

        when die or warehouse_expand_time.timer begin
            warehouse_expand.abort_quest()
            clear_letter()
            target.delete("__TARGET__")
        end

        when button or info begin
            say_info()
            say_split(string.format(translate.warehouse_expand.state_progress.letter_info, get_map_name(get_player_map2_index())))
        end

        when __TARGET__.target.click or 9005.chat.translate.warehouse_expand.quest_name with pc.get_map_index() == get_player_map2_index() begin
            target.delete("__TARGET__")

            if not pc.has_affect(AFFECT_QUEST_USE) then
                warehouse_expand.abort_quest()
                clear_letter()
                return
            else
                affect.remove(AFFECT_QUEST_USE)
            end
            q.set_clock("Czas", 0)

            npc_name()
            say_split(translate.warehouse_expand.state_progress.npc_talk1)
            wait()
            say_title_pc_name()
            say_split(translate.warehouse_expand.state_progress.pc_talk1)
            wait()
            npc_name()
            say_split(string.format(translate.warehouse_expand.state_progress.npc_talk2, get_map_name(get_player_map1_index())))
            clear_letter()
            set_state(reward)
        end
    end
    state reward begin
        when letter begin
            send_letter(translate.warehouse_expand.quest_name)
            if pc.get_map_index() == get_player_map1_index() then
                send_target(9005)
            end
        end
        when button or info begin
            say_info()
            say_split(translate.warehouse_expand.state_reward.letter_info)
        end
        when __TARGET__.target.click or 9005.chat.translate.warehouse_expand.quest_name with pc.get_map_index() == get_player_map1_index() begin
            target.delete("__TARGET__")
            npc_name()
            say_split(translate.warehouse_expand.state_reward.npc_talk1)
            say()
            say_reward(translate.warehouse_expand.state_reward.reward)
            
            game.set_safebox_level(2)
            pc.set_account_flag("safebox_level", 1)
            clear_letter()
            set_state(__COMPLETE__)
        end
    end
    state __COMPLETE__ begin
    end
end