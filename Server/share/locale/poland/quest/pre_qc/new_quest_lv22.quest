quest new_quest_lv22 begin
    state start begin
		function npc_chat()
	        target.delete("__TARGET__")
	        say_title(gameforge.new_quest_lv22._017_say_title) -- yellow text headline
	        say(gameforge.new_quest_lv22._021_say) -- white font text
			wait()
			say_title(gameforge.new_quest_lv22._017_say_title) -- yellow text headline
	        say(gameforge.new_quest_lv22._022_say)
    	end	

		when login or levelup with pc.get_level() >= 22 begin
			q.done()
			set_state(information)
		end
	end
	-- get information from the cityguard about his sick brother----------------------------------------
	state information begin
		when login or enter begin
		-- edit Rui, adding a letter and questmark in the quest menu --
			send_letter(gameforge.new_quest_lv22._015_npcChat)
			q.start()
			q.set_title(gameforge.new_quest_lv22._015_npcChat)
		-- finished the edit --
			local find_npc_vnum = 0
			if pc.get_empire()==1 then
				find_npc_vnum = 11000
			elseif pc.get_empire()==2 then
				find_npc_vnum = 11002
			elseif pc.get_empire()==3 then
				find_npc_vnum = 11004
			end
			local v=find_npc_by_vnum(find_npc_vnum) -- W�chter des Dorfplatzes
			if 0==v then
			else
				target.vid("__TARGET__", v, gameforge.new_quest_lv22._010_target)
			end
		end
		-- edit Rui, added the text that should be shown when opening the letter or pressing the quest button in the quest menu --
		when button or info begin
			say_title(gameforge.new_quest_lv22._015_npcChat)
			say("")
			say(gameforge.new_quest_lv22._011_say)
		end
	
		when 11000.chat.gameforge.new_quest_lv22._015_npcChat or 11002.chat.gameforge.new_quest_lv22._015_npcChat or 11004.chat.gameforge.new_quest_lv22._015_npcChat  begin
			target.delete("__TARGET__")
	        say_title(gameforge.new_quest_lv22._017_say_title) -- yellow text headline
	        say(gameforge.new_quest_lv22._021_say) -- white font text
			wait()
			say_title(gameforge.new_quest_lv22._017_say_title) -- yellow text headline
	        say(gameforge.new_quest_lv22._022_say)
			q.done()
			local doquest = select(gameforge.new_quest_lv22._024_select, gameforge.subquest_12._50_select, gameforge.new_quest_lv75._290_2_select)
			if doquest ==1 then 
				set_state(ask_beakgo)
			elseif doquest == 3 then
				say(gameforge.subquest_06._60_say)
				local abortquest = select(gameforge.subquest_06._70_select, gameforge.subquest_06._80_select)
				if abortquest == 1 then
					set_state(__GIVEUP__)
				else
					say(gameforge.subquest_11._80_say)
					return
				end
			else
				say(gameforge.subquest_11._80_say)
				return
			end
		end
	end
	-- ask baek-go for medicine ------------------------------------------------------------------------
	state ask_beakgo begin
		when enter or login begin
			--BEGIN EDIT by Arne 21Sept09, accoridng to manits26067, Reason: missing quest, letter
			send_letter(gameforge.new_quest_lv22._016_send_letter)
			q.start()
			q.set_title(gameforge.new_quest_lv22._016_send_letter)
			
			local v=find_npc_by_vnum(20018)
			if 0!=v then
					target.vid("__TARGET2__", v, gameforge.new_quest_lv22._030_target)
			end
			--END EDIT
		end
		
		--BEGIN EDIT by Arne 21Sept09, accoridng to manits26067, Reason: missing quest, letter
		when info or button begin
			say_title(gameforge.new_quest_lv22._025_say_title)
			say(gameforge.new_quest_lv22._026_say)
			say("")
			say(string.format(gameforge.new_quest_lv22._027_say, get_map_name_by_number(1)))
		end
		--END EDIT
		
		
		when 20018.chat.gameforge.new_quest_lv22._016_send_letter begin
			target.delete("__TARGET2__")
			say_title(gameforge.new_quest_lv22._018_say_title)
			say(gameforge.new_quest_lv22._031_say)
			local b= select(gameforge.new_quest_lv22._032_1_select, gameforge.new_quest_lv22._032_2_select, gameforge.new_quest_lv22._032_3_select)
			if b==1 then
				say_title(gameforge.new_quest_lv22._018_say_title)
				say(gameforge.new_quest_lv22._035_say)
			wait()
				say_title(gameforge.new_quest_lv22._018_say_title)
				say(gameforge.new_quest_lv22._040_say)
				say_reward(string.format("%s x", 1))
				say_item_vnum(35000) -- icon of item
				say_reward(gameforge.new_quest_lv22._041_say_reward)
				say(mob_name(115))
			wait()
				say_title(gameforge.new_quest_lv22._018_say_title)
				say(gameforge.new_quest_lv22._042_say)
				say_reward(string.format("%s x",  1))
				say_item_vnum(35001) -- icon of item
				say_reward(gameforge.new_quest_lv22._041_say_reward)
				say(mob_name(114))
				q.done()
				set_state(hunting)
			elseif b==2 then
				say_title(gameforge.new_quest_lv22._018_say_title)
				say(gameforge.new_quest_lv22._043_say)
				q.done()
				set_state(information)
			else
				say_title(gameforge.new_quest_lv22._018_say_title)
				say(gameforge.new_quest_lv22._044_say)
				q.done()
				set_state(information)
			end
		end
	end
	-- hunt tigers and white tiger for ingrediences for the medicine -----------------------------------
	state hunting begin
		when enter begin
			local hunting_count = pc.getqf("hunting_count") + 1
			pc.setqf("hunting_count", hunting_count)
		end
	
		when enter or login begin
		--BEGIN EDIT by Arne 21Sept09, accoridng to manits26067, Reason: missing quest, letter
			send_letter(gameforge.new_quest_lv22._016_send_letter)
			q.start()
			q.set_title(gameforge.new_quest_lv22._016_send_letter)
		--END EDIT
		end

		-------------- medical wheat ------------------------------------------------------
		when 115.kill begin
			if pc.count_item(35000) < 1 then
				if number(1,100) <= 30 then -- probability if s.th. drops
					pc.give_item2(35000) -- medical wheat
					if 1 == pc.count_item(35000) and 1 == pc.count_item(35001) then
						-- collected everything
						notice_multiline(gameforge.new_quest_lv22._057_notice, notice)
						q.done()
						set_state(back_to_baekgo)
					else
						if 1 == pc.count_item(35000) then
							-- collected all wheat, still need livers
							notice_multiline(string.format(gameforge.new_quest_lv22._058_notice, 1-pc.count_item(35001)), notice)
						else
							-- need more wheat
							notice_multiline(string.format(gameforge.new_quest_lv22._056_notice , 1-pc.count_item(35000)), notice)
						end
					end
				else
				end
			end
		end

		-------------- Tigerleber ------------------------------------------------------
		when 114.kill begin
			if pc.count_item(35001) <  1 then
				if number(1,100) <= 30 then -- probability if s.th. drops
					pc.give_item2(35001) -- tigerleber
					
					if 1 == pc.count_item(35000) and  1 == pc.count_item(35001) then
						-- collected everything
						notice_multiline(gameforge.new_quest_lv22._061_notice, notice)
						q.done()
						set_state(back_to_baekgo)
					else
						if 1 == pc.count_item(35001) then
							-- collected all livers, still need wheat
							notice_multiline(string.format(gameforge.new_quest_lv22._056_notice , 1-pc.count_item(35000)), notice)
						else
							-- still need livers
							notice_multiline(string.format(gameforge.new_quest_lv22._060_notice,  1-pc.count_item(35001)), notice)
						end
					end
				else
					notice_multiline(gameforge.new_quest_lv22._062_notice, notice)
				end
			end
		end
		when info or button begin
			if 1 >  pc.count_item(35000) or  1 >  pc.count_item(35001) then
				say_title(gameforge.new_quest_lv22._016_send_letter)
				say(gameforge.new_quest_lv22._066_say)
				if 1 >  pc.count_item(35000) then
					say_reward(string.format(gameforge.new_quest_lv22._063_say, 1-pc.count_item(35000), mob_name(115)))
				end
				if  1 >  pc.count_item(35001) then
					say_reward(string.format(gameforge.new_quest_lv22._064_say,  1-pc.count_item(35001), mob_name(114)))
				end
			else
                say_title(gameforge.new_quest_lv22._025_say_title)
				say(gameforge.new_quest_lv22._065_say)
				set_state(back_to_baekgo)
			end
		end
	end
	-- bring the ingrediences back to baek-go ----------------------------------------------------------
	state back_to_baekgo begin
		when enter or login begin
			--BEGIN EDIT by Arne 21Sept09, accoridng to manits26067, Reason: missing quest, letter
			send_letter(gameforge.new_quest_lv22._016_send_letter)
			q.set_title(gameforge.new_quest_lv22._016_send_letter)			
			local timeLeft = 1200-(get_time()-pc.getqf("new_quest_lv22_startTime"))
			displayTime = timeLeft / 60
			q.set_clock(gameforge.new_quest_lv22._082_set_clock, timeLeft)
			q.start()
			local v=find_npc_by_vnum(20018) -- Baek-Go
			if 0==v then
			else
				target.vid("__TARGET3__", v, gameforge.new_quest_lv22._030_target)
			end
			--END EDIT
		end
		
		--BEGIN EDIT by Arne 21Sept09, accoridng to manits26067, Reason: missing quest, letter
		when info or button begin
		say_title(gameforge.new_quest_lv22._016_send_letter)
		say(gameforge.new_quest_lv22._065_say)
		say("")
		say(string.format(gameforge.new_quest_lv22._027_say, get_map_name_by_number(1)))
		end
		--END EDIT
		
		when 20018.chat.gameforge.new_quest_lv22._016_send_letter begin
			target.delete("__TARGET3__")
			say_title(gameforge.new_quest_lv22._018_say_title)
			if  pc.count_item(35000) >= 1 and pc.count_item(35001) >=  1 then
				say(gameforge.new_quest_lv22._070_say)
				pc.remove_item(35000, 1)
				pc.remove_item(35001,  1)
			wait()
				say_title(gameforge.new_quest_lv22._018_say_title)
				say(string.format(gameforge.new_quest_lv22._071_say, 1200 / 60))
				say(gameforge.new_quest_lv22._072_say)
				pc.give_item2(35002, 1)
				pc.setqf("new_quest_lv22_startTime", get_time())
				q.done()
				set_state(find_brother)
				return
			else
				-- this happens, if the player sold or dropped needed items:
				say(gameforge.new_quest_lv22._073_say)
				q.done()
				set_state(hunting)
			end
		end
	end
	-- bring the medicine to the sick brother in the hwang temple (entrance of the demon tower) 20min time limit --
	state find_brother begin
        when enter or login begin
			send_letter(gameforge.new_quest_lv22._016_send_letter)--EDIT by Arne 21Sept09, accoridng to manits26067, Reason: missing letter
			
			q.set_title(gameforge.new_quest_lv22._016_send_letter)
			local timeLeft = 1200-(get_time()-pc.getqf("new_quest_lv22_startTime"))
			displayTime = timeLeft / 60
			q.set_clock(gameforge.new_quest_lv22._082_set_clock, timeLeft)
			q.start()
			if is_destination_village(65) then -- 
				local v=find_npc_by_vnum(20348) -- W�chter des D�monenturms
				if 0!=v then
					target.vid("__TARGET4__", v, gameforge.new_quest_lv22._080_target)
				end
			end
		end
		when button or info begin
			say_title(gameforge.new_quest_lv22._016_send_letter)
			if get_time() - pc.getqf("new_quest_lv22_startTime") <= 1200 then
				say(gameforge.new_quest_lv22._083_say)
			else
				say(gameforge.new_quest_lv22._084_say)
			end
		end
		when 20348.chat.gameforge.new_quest_lv22._016_send_letter begin
			target.delete("__TARGET4__")
			say_title(gameforge.new_quest_lv22._019_say_title)
			q.done()
			-- player succeeded in bringing the medicine in time
			if pc.count_item(35002) >= 1 and get_time() - pc.getqf("new_quest_lv22_startTime") <= 1200 then
				pc.remove_item(35002, 1)
				say(gameforge.new_quest_lv22._085_say)
				say(gameforge.new_quest_lv22._086_say)
				say(gameforge.new_quest_lv22._087_say)
				set_state(__COMPLETE__)
				give_reward("new_quest_lv22_success")
				return
			-- player failed in bringing the medicine in time
			elseif pc.count_item(35002) >= 1 and get_time() - pc.getqf("new_quest_lv22_startTime") > 1200 then
				pc.remove_item(35002, 1)
				say(gameforge.new_quest_lv22._085_say)
				say(gameforge.new_quest_lv22._089_say)
			wait()
				say_title(gameforge.new_quest_lv22._019_say_title)
				say(gameforge.new_quest_lv22._090_say)
				set_state(__COMPLETE__)
				give_reward("new_quest_lv22_fail")
				return
			-- player lost the medicine ----------------------------
			else
				say(gameforge.new_quest_lv22._091_say)
				set_state(hunting)
			end	
		end
	end
	------  give up ------------------------------------------------------------------------------------------------------
	state __GIVEUP__ begin
	end
	------  complete ------------------------------------------------------------------------------------------------------
	state __COMPLETE__ begin
		when enter begin
			pc.setqf("new_quest_lv22_startTime",0)
		end
	end
end 
